name: Pin to NFT.Storage

# SAFETY: Manual dispatch only - no automatic triggers
# This workflow requires NFT_STORAGE_KEY secret to be present
# DO NOT run pinning automatically on push or PR open
# DO NOT broadcast transactions from CI
on:
  workflow_dispatch:
    inputs:
      directory:
        description: 'Directory to pin (e.g., metadata/ or outputs/)'
        required: true
        default: 'outputs'
        type: choice
        options:
          - metadata
          - outputs
          - data
      pin_name:
        description: 'Name for the pin on NFT.Storage'
        required: true
        default: 'megazion-48fold-codex'
        type: string

jobs:
  pin-to-nftstorage:
    runs-on: ubuntu-latest
    
    # Gate: Only run if NFT_STORAGE_KEY secret is present
    if: ${{ secrets.NFT_STORAGE_KEY != '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Check for NFT_STORAGE_KEY secret
        run: |
          if [ -z "${{ secrets.NFT_STORAGE_KEY }}" ]; then
            echo "❌ Error: NFT_STORAGE_KEY secret is not set"
            echo "Please configure the NFT_STORAGE_KEY repository secret"
            echo "See: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "✓ NFT_STORAGE_KEY secret is configured"
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Verify directory exists
        run: |
          if [ ! -d "${{ github.event.inputs.directory }}" ]; then
            echo "❌ Error: Directory ${{ github.event.inputs.directory }} does not exist"
            exit 1
          fi
          echo "✓ Directory ${{ github.event.inputs.directory }} found"
          echo "Contents:"
          ls -lh ${{ github.event.inputs.directory }}
      
      - name: Pin directory to NFT.Storage
        env:
          NFT_STORAGE_KEY: ${{ secrets.NFT_STORAGE_KEY }}
        run: |
          echo "Pinning ${{ github.event.inputs.directory }} to NFT.Storage..."
          echo "Pin name: ${{ github.event.inputs.pin_name }}"
          
          # WARNING: The following script is a placeholder and does NOT pin files.
          # The nft.storage npm package is deprecated.
          # You MUST migrate to the w3up API before using this workflow.
          # See: https://nft.storage/docs/how-to/migrate-to-w3up/
          
          cat > pin_script.js << 'PINSCRIPT'
          // WARNING: This script is a placeholder and does NOT pin files to NFT.Storage.
          // The nft.storage npm package is deprecated and should NOT be used.
          // To pin files, migrate to the new w3up API: https://github.com/nftstorage/w3up
          // See: https://nft.storage/docs/how-to/migrate-to-w3up/
          // Remove this script and implement pinning using @nftstorage/w3up-client.
          // Example usage: https://github.com/nftstorage/w3up/tree/main/examples
          
          const fs = require('fs');
          const path = require('path');
          
          async function pin() {
            const directory = process.argv[2];
            const pinName = process.argv[3];
            
            console.log(`\n❌ ERROR: This script is a placeholder and does NOT pin files to NFT.Storage.`);
            console.log(`The nft.storage npm package is deprecated.`);
            console.log(`\nTo enable pinning:`);
            console.log(`  1. Install: npm install @nftstorage/w3up-client`);
            console.log(`  2. Migrate to w3up API: https://nft.storage/docs/how-to/migrate-to-w3up/`);
            console.log(`  3. Update this script to use the new API`);
            console.log(`\nDirectory: ${directory}`);
            console.log(`Pin name: ${pinName}`);
            
            // Read all files in directory for information
            if (fs.existsSync(directory)) {
              const files = fs.readdirSync(directory);
              console.log(`\nFound ${files.length} files in ${directory}:`);
              
              for (const file of files) {
                const filePath = path.join(directory, file);
                if (fs.statSync(filePath).isFile()) {
                  console.log(`  - ${file}`);
                }
              }
            }
            
            console.log(`\nAfter implementing w3up API, replace ipfs://REPLACE_WITH_CID placeholders with actual CIDs.`);
            process.exit(1);
          }
          
          pin().catch(console.error);
          PINSCRIPT
          
          node pin_script.js "${{ github.event.inputs.directory }}" "${{ github.event.inputs.pin_name }}"
      
      - name: Summary
        if: always()
        run: |
          echo "## Pin to NFT.Storage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Directory:** \`${{ github.event.inputs.directory }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Pin Name:** \`${{ github.event.inputs.pin_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- This workflow runs **manually only** via workflow_dispatch" >> $GITHUB_STEP_SUMMARY
          echo "- No transactions are broadcast from CI" >> $GITHUB_STEP_SUMMARY
          echo "- Requires NFT_STORAGE_KEY repository secret" >> $GITHUB_STEP_SUMMARY
          echo "- Update placeholder CIDs in code after pinning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Retrieve the CID from NFT.Storage" >> $GITHUB_STEP_SUMMARY
          echo "2. Update \`ipfs://REPLACE_WITH_CID\` placeholders" >> $GITHUB_STEP_SUMMARY
          echo "3. See README documentation for complete workflow" >> $GITHUB_STEP_SUMMARY
